doctype html
html(lang="en")
    head
        meta(charset="UTF-8")
        meta(name="viewport" content="width=device-width, initial-scale=1.0")
        title= title || 'BUG Radio'

        //- Fonts
        link(rel="preconnect" href="https://fonts.googleapis.com")
        link(rel="preconnect" href="https://fonts.gstatic.com" crossorigin)
        link(href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet")

        //- Random backgrounds: picks independently from sfondi/ (dx) and sfondi-sx/ (sx)
        script.
            (function() {
                var n  = Math.floor(Math.random() * 12) + 1;
                var sx = Math.floor(Math.random() * 12) + 1;
                document.documentElement.style.setProperty('--bg-sfondo',    'url("/public/assets/sfondi/'    + n  + '.png")');
                document.documentElement.style.setProperty('--bg-sfondo-sx', 'url("/public/assets/sfondi-sx/' + sx + '.png")');
            })();

        //- CSS
        link(rel="stylesheet" href="/public/css/style.css")
        link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css")

        //- Alpine.js
        script(defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js")

        style.
            /* Now Playing Metadata Styles */
            .now-playing {
                padding: 0.75rem 0;
                text-align: center;
                min-height: 3.5rem;
            }

            .now-playing-content {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            .track-info {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                font-size: 0.9rem;
            }

            .track-title {
                font-weight: 700;
                color: #333;
            }

            .track-artist {
                color: #666;
            }

            .now-playing .show-name {
                font-size: 0.75rem;
                color: #999;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .now-playing-label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: #e53935;
                margin-bottom: 0.25rem;
            }

            .metadata-loading {
                color: #999;
                font-size: 0.8rem;
            }

    body
        header.site-header
            .container
                .header-top
                    img.logo(src="/public/assets/logo.png" alt="BUG Radio")

                    nav.main-nav
                        a(href="/" class=currentPath === '/' ? 'active' : '') HOME
                        a(href="/about" class=currentPath === '/about' ? 'active' : '') ABOUT
                        a(href="/gallery" class=currentPath === '/gallery' ? 'active' : '') GALLERY
                        a(href="/shows" class=currentPath === '/shows' ? 'active' : '') SHOWS
                        a(href="/schedule" class=currentPath === '/schedule' ? 'active' : '') SCHEDULE
                        a(href="/open-call" class=currentPath === '/open-call' ? 'active' : '') OPEN CALL
                        a(href="/education" class=currentPath === '/education' ? 'active' : '') EDUCATION
                        a(href="/partners" class=currentPath === '/partners' ? 'active' : '') PARTNERS

                    //- Hamburger Menu Button
                    button.hamburger-btn(
                        onclick="toggleMobileMenu()"
                        aria-label="Toggle menu"
                        aria-expanded="false"
                    )
                        span.hamburger-line
                        span.hamburger-line
                        span.hamburger-line

                    //- Mobile Menu Overlay
                    .mobile-menu-overlay(onclick="toggleMobileMenu()")

                    //- Mobile Menu
                    nav.mobile-nav
                        a(href="/" class=currentPath === '/' ? 'active' : '') HOME
                        a(href="/about" class=currentPath === '/about' ? 'active' : '') ABOUT
                        a(href="/gallery" class=currentPath === '/gallery' ? 'active' : '') GALLERY
                        a(href="/shows" class=currentPath === '/shows' ? 'active' : '') SHOWS
                        a(href="/schedule" class=currentPath === '/schedule' ? 'active' : '') SCHEDULE
                        a(href="/open-call" class=currentPath === '/open-call' ? 'active' : '') OPEN CALL
                        a(href="/education" class=currentPath === '/education' ? 'active' : '') EDUCATION
                        a(href="/partners" class=currentPath === '/partners' ? 'active' : '') PARTNERS

        //- Audio Visualizer
        script(src="/public/js/audio-visualizer.js")

        //- Mobile Menu Toggle
        script.
            function toggleMobileMenu() {
                const hamburger = document.querySelector('.hamburger-btn');
                const mobileNav = document.querySelector('.mobile-nav');
                const overlay = document.querySelector('.mobile-menu-overlay');
                const body = document.body;

                const isOpen = mobileNav.classList.contains('open');

                if (isOpen) {
                    hamburger.classList.remove('active');
                    mobileNav.classList.remove('open');
                    overlay.classList.remove('active');
                    body.classList.remove('menu-open');
                    hamburger.setAttribute('aria-expanded', 'false');
                } else {
                    hamburger.classList.add('active');
                    mobileNav.classList.add('open');
                    overlay.classList.add('active');
                    body.classList.add('menu-open');
                    hamburger.setAttribute('aria-expanded', 'true');
                }
            }

            // Close menu on ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const mobileNav = document.querySelector('.mobile-nav');
                    if (mobileNav && mobileNav.classList.contains('open')) {
                        toggleMobileMenu();
                    }
                }
            });

        script.
            function radioPlayer() {
                return {
                    playing: false,
                    isLive: false,
                    streamUrl: 'https://bugradio2024.out.airtime.pro/bugradio2024_a',
                    apiUrl: 'https://bugradio2024.airtime.pro/api/live-info-v2',
                    currentTrack: {title: '', artist: ''},
                    currentShow: '',
                    metadataInterval: null,

                    init() {
                        this.fetchMetadata();
                        this.metadataInterval = setInterval(() => this.fetchMetadata(), 15000);
                    },

                    togglePlay() {
                        if (this.playing) {
                            this.$refs.audio.pause();
                            this.$refs.audio.src = '';
                        } else {
                            this.$refs.audio.src = this.streamUrl;
                            this.$refs.audio.play().catch(() => {
                            });
                        }
                        this.playing = !this.playing;
                    },

                    async fetchMetadata() {
                        try {
                            const response = await fetch(this.apiUrl, {cache: 'no-store'});
                            if (!response.ok) throw new Error('API error');
                            const data = await response.json();

                            const currentShow = data.shows?.current;
                            const currentTrack = data.tracks?.current;

                            // Lo stream è live solo se l'API riporta uno show attivo
                            this.isLive = !!(currentShow && currentShow.name);

                            if (!this.isLive) {
                                this.currentTrack = {title: '', artist: ''};
                                this.currentShow = '';
                                // Se stava suonando, ferma
                                if (this.playing) {
                                    this.$refs.audio.pause();
                                    this.$refs.audio.src = '';
                                    this.playing = false;
                                }
                                return;
                            }

                            this.currentTrack = {
                                title: currentTrack?.name || '',
                                artist: currentTrack?.metadata?.artist || ''
                            };
                            this.currentShow = currentShow?.name || '';

                        } catch (error) {
                            // Nessuna risposta dall'API → offline
                            this.isLive = false;
                            this.currentTrack = {title: '', artist: ''};
                            this.currentShow = '';
                        }
                    }
                }
            }


        main
            block content

        footer.site-footer
            .footer-top
                .footer-section
                    h3 JOIN OUR COMMUNITY
                    a(href="/open-call") SUBMIT YOUR SHOW
                .footer-section
                    h3 BUG RADIO IS SUPPORTED BY...
                    a(href="/partners") PARTNERS

            .footer-bottom
                p © #{new Date().getFullYear()} BUG Radio
