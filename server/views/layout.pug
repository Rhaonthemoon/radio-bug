doctype html
html(lang="en")
    head
        meta(charset="UTF-8")
        meta(name="viewport" content="width=device-width, initial-scale=1.0")
        title= title || 'BUG Radio'

        //- Fonts
        link(rel="preconnect" href="https://fonts.googleapis.com")
        link(rel="preconnect" href="https://fonts.gstatic.com" crossorigin)
        link(href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet")

        //- Random backgrounds: picks independently from sfondi/ (dx) and sfondi-sx/ (sx)
        script.
            (function() {
                var n  = Math.floor(Math.random() * 12) + 1;
                var sx = Math.floor(Math.random() * 12) + 1;
                document.documentElement.style.setProperty('--bg-sfondo',    'url("/public/assets/sfondi/'    + n  + '.png")');
                document.documentElement.style.setProperty('--bg-sfondo-sx', 'url("/public/assets/sfondi-sx/' + sx + '.png")');
            })();

        //- CSS
        link(rel="stylesheet" href="/public/css/style.css")
        link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css")

        //- Alpine.js
        script(defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js")

        style.
            /* Now Playing Metadata Styles */
            .now-playing {
                padding: 0.75rem 0;
                text-align: center;
                min-height: 3.5rem;
            }

            .now-playing-content {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            .track-info {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
                font-size: 0.9rem;
            }

            .track-title {
                font-weight: 700;
                color: #333;
            }

            .track-artist {
                color: #666;
            }

            .now-playing .show-name {
                font-size: 0.75rem;
                color: #999;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .now-playing-label {
                font-size: 0.65rem;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                color: #e53935;
                margin-bottom: 0.25rem;
            }

            .metadata-loading {
                color: #999;
                font-size: 0.8rem;
            }

            /* ── GLOBAL PLAYER BAR ─────────────────────── */
            .global-player {
                position: sticky;
                top: 108px;
                display: flex;
                z-index: 90;
            background: var(--color-bg, #fff);
            border-bottom: 1px solid rgba(0,0,0,0.08);
                padding: 0.5rem 1.5rem;
                min-height: 3rem;
                justify-content: center;
            }

            .global-player-live {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .global-btn-play {
                flex-shrink: 0;
                width: 2.2rem;
                height: 2.2rem;
                border-radius: 50%;
                border: 2px solid currentColor;
                background: none;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.75rem;
                transition: background 0.2s, color 0.2s;
            }
            .global-btn-play:hover {
                background: currentColor;
            }
            .global-btn-play:hover i {
                color: #fff;
            }

            .global-audio-visualizer {
                flex-shrink: 0;
                width: 60px;
                height: 24px;
            }

            .global-player-meta {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 0.25rem 0.75rem;
                min-width: 0;
            }

            .global-on-air {
                font-size: 0.6rem;
                font-weight: 700;
                letter-spacing: 0.18em;
                color: #e53935;
                text-transform: uppercase;
                flex-shrink: 0;
            }

            .global-show-name {
                font-size: 0.75rem;
                font-weight: 700;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .global-track {
                font-size: 0.75rem;
                opacity: 0.6;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                display: flex;
                align-items: center;
            }

            .global-track-title {
                font-weight: 600;
            }

            .global-track-artist {
                font-weight: 400;
            }

            .global-player-offline {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.7rem;
                font-weight: 700;
                letter-spacing: 0.16em;
                text-transform: uppercase;
                opacity: 0.35;
            }

            @media (max-width: 600px) {
                .global-player { padding: 0.5rem 1rem; }
                .global-audio-visualizer { display: none; }
                .global-show-name,
                .global-track { max-width: 180px; }
            }

    body
        header.site-header
            .container
                .header-top
                    img.logo(src="/public/assets/logo.png" alt="BUG Radio")

                    nav.main-nav
                        a(href="/" class=currentPath === '/' ? 'active' : '') HOME
                        a(href="/about" class=currentPath === '/about' ? 'active' : '') ABOUT
                        a(href="/gallery" class=currentPath === '/gallery' ? 'active' : '') GALLERY
                        a(href="/shows" class=currentPath === '/shows' ? 'active' : '') SHOWS
                        a(href="/schedule" class=currentPath === '/schedule' ? 'active' : '') SCHEDULE
                        a(href="/open-call" class=currentPath === '/open-call' ? 'active' : '') OPEN CALL
                        a(href="/education" class=currentPath === '/education' ? 'active' : '') EDUCATION
                        a(href="/partners" class=currentPath === '/partners' ? 'active' : '') PARTNERS

                    //- Hamburger Menu Button
                    button.hamburger-btn(
                        onclick="toggleMobileMenu()"
                        aria-label="Toggle menu"
                        aria-expanded="false"
                    )
                        span.hamburger-line
                        span.hamburger-line
                        span.hamburger-line

                    //- Mobile Menu Overlay
                    .mobile-menu-overlay(onclick="toggleMobileMenu()")

                    //- Mobile Menu
                    nav.mobile-nav
                        a(href="/" class=currentPath === '/' ? 'active' : '') HOME
                        a(href="/about" class=currentPath === '/about' ? 'active' : '') ABOUT
                        a(href="/gallery" class=currentPath === '/gallery' ? 'active' : '') GALLERY
                        a(href="/shows" class=currentPath === '/shows' ? 'active' : '') SHOWS
                        a(href="/schedule" class=currentPath === '/schedule' ? 'active' : '') SCHEDULE
                        a(href="/open-call" class=currentPath === '/open-call' ? 'active' : '') OPEN CALL
                        a(href="/education" class=currentPath === '/education' ? 'active' : '') EDUCATION
                        a(href="/partners" class=currentPath === '/partners' ? 'active' : '') PARTNERS

        //- Audio Visualizer
        script(src="/public/js/audio-visualizer.js")

        //- PJAX — navigazione senza ricaricare il player
        script(src="/public/js/pjax.js" defer)

        //- Mobile Menu Toggle
        script.
            function toggleMobileMenu() {
                const hamburger = document.querySelector('.hamburger-btn');
                const mobileNav = document.querySelector('.mobile-nav');
                const overlay = document.querySelector('.mobile-menu-overlay');
                const body = document.body;

                const isOpen = mobileNav.classList.contains('open');

                if (isOpen) {
                    hamburger.classList.remove('active');
                    mobileNav.classList.remove('open');
                    overlay.classList.remove('active');
                    body.classList.remove('menu-open');
                    hamburger.setAttribute('aria-expanded', 'false');
                } else {
                    hamburger.classList.add('active');
                    mobileNav.classList.add('open');
                    overlay.classList.add('active');
                    body.classList.add('menu-open');
                    hamburger.setAttribute('aria-expanded', 'true');
                }
            }

            // Close menu on ESC key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const mobileNav = document.querySelector('.mobile-nav');
                    if (mobileNav && mobileNav.classList.contains('open')) {
                        toggleMobileMenu();
                    }
                }
            });

        script.
            function radioPlayer() {
                return {
                    playing: false,
                    isLive: false,
                    streamUrl: 'https://bugradio2024.out.airtime.pro/bugradio2024_a',
                    apiUrl: 'https://bugradio2024.airtime.pro/api/live-info-v2',
                    currentTrack: { title: '', artist: '' },
                    currentShow: '',
                    metadataInterval: null,

                    init() {
                        this.fetchMetadata();
                        this.metadataInterval = setInterval(() => this.fetchMetadata(), 15000);
                    },

                    togglePlay() {
                        if (this.playing) {
                            this.$refs.audio.pause();
                            this.$refs.audio.src = '';
                        } else {
                            this.$refs.audio.src = this.streamUrl;
                            this.$refs.audio.play().catch(() => {});
                        }
                        this.playing = !this.playing;
                    },

                    async fetchMetadata() {
                        try {
                            const res = await fetch(this.apiUrl, { cache: 'no-store' });
                            if (!res.ok) throw new Error('API error');
                            const data = await res.json();

                            const show  = data.shows?.current;
                            const track = data.tracks?.current;

                            // isLive = true solo se Airtime riporta uno show attivo
                            this.isLive = !!(show && show.name);

                            if (!this.isLive) {
                                this.currentTrack = { title: '', artist: '' };
                                this.currentShow  = '';
                                if (this.playing) {
                                    this.$refs.audio.pause();
                                    this.$refs.audio.src = '';
                                    this.playing = false;
                                }
                                return;
                            }

                            this.currentShow  = show.name || '';
                            this.currentTrack = {
                                title:  track?.name              || '',
                                artist: track?.metadata?.artist  || ''
                            };

                        } catch (err) {
                            // API irraggiungibile → offline
                            this.isLive = false;
                            this.currentTrack = { title: '', artist: '' };
                            this.currentShow  = '';
                        }
                    }
                }
            }

        //- ── GLOBAL PLAYER BAR (nascosto in home via JS) ──────────
        .global-player(x-data="radioPlayer()" x-init="init()")

            template(x-if="isLive")
                div.global-player-live
                    //- Play button
                    button.global-btn-play(@click="togglePlay()" aria-label="Play / Pause")
                        i.fa-solid.fa-play(x-show="!playing")
                        i.fa-solid.fa-pause(x-show="playing")

                    //- Audio element
                    audio#global-player-audio(
                        x-ref="audio"
                        :src="streamUrl"
                        preload="none"
                        crossorigin="anonymous"
                    )

                    //- Visualizer
                    #global-visualizer.global-audio-visualizer

                    //- Metadata
                    .global-player-meta
                        .global-on-air ON AIR
                        template(x-if="currentShow")
                            span.global-show-name(x-text="currentShow")
                        template(x-if="currentTrack.title")
                            .global-track
                                span.global-track-title(x-text="currentTrack.title")
                                template(x-if="currentTrack.artist")
                                    span.global-track-artist
                                        | &nbsp;—&nbsp;
                                        span(x-text="currentTrack.artist")

            template(x-if="!isLive")
                .global-player-offline
                    i.fa-regular.fa-circle-dot
                    span RADIO IS OFFLINE

        main
            block content

        footer.site-footer
            .footer-top
                .footer-section
                    h3 JOIN OUR COMMUNITY
                    a(href="/open-call") SUBMIT YOUR SHOW
                .footer-section
                    h3 BUG RADIO IS SUPPORTED BY...
                    a(href="/partners") PARTNERS

            .footer-bottom
                p © #{new Date().getFullYear()} BUG Radio
